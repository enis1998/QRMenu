<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Categories & Products</title>
    <script th:src="@{/js/tailwind-3.4.3.js}"></script>
    <!-- Sortable.js CDN for drag/drop -->
    <script th:src="@{/js/sortable-1.15.0.js}"></script>
    <link rel="stylesheet" th:href="@{/css/dragAndSort.css}"/>
    <script th:src="@{/js/jquery.min.js}"></script>
    <script th:src="@{/js/dragAndSort.js}"></script>
</head>
<body class="bg-gray-100 min-h-screen flex">

<!-- Dil Se√ßici (bayraklar yan yana) -->
<header class="absolute top-4 right-4 flex space-x-2">
    <a th:href="@{/admin/products(lang='tr')}"
       class="inline-block">
        <img th:src="@{/images/tr.png}" alt="TR" class="w-6 h-4"/>
    </a>
    <a th:href="@{/admin/products(lang='en')}"
       class="inline-block">
        <img th:src="@{/images/en.png}" alt="EN" class="w-6 h-4"/>
    </a>
</header>

<!-- Yan Men√º -->
<aside class="w-64 bg-white shadow-lg z-40">
    <div class="p-6 font-bold text-xl border-b" th:text="#{menu.adminPanel}">Admin Panel</div>
    <nav class="mt-4 space-y-1">
        <a th:href="@{/admin/dashboard(lang=${param.lang})}"
           class="block px-6 py-3 hover:bg-gray-200"
           th:text="#{menu.dashboard}">üè† Dashboard</a>
        <a th:href="@{/admin/users(lang=${param.lang})}"
           class="block px-6 py-3 hover:bg-gray-200"
           th:text="#{menu.users}">üë• Users</a>
        <a th:href="@{/admin/products(lang=${param.lang})}"
           class="block px-6 py-3 hover:bg-gray-200"
           th:text="#{menu.products}">üì¶ Products</a>
        <form th:action="@{/admin/logout(lang=${param.lang})}" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <button type="submit"
                    class="w-full text-left px-6 py-3 hover:bg-gray-200 text-red-600"
                    th:text="#{menu.logout}">üö™ Logout
            </button>
        </form>
    </nav>
</aside>

<!-- Main content -->
<main class="flex-1 p-6 space-y-6">

    <!-- Tab ba≈ülƒ±klarƒ± -->
    <div class="flex space-x-4 border-b">
        <button id="tabTable" class="pb-2 border-b-2 border-indigo-600 font-medium">Table View</button>
        <button id="tabDrag" class="pb-2 text-gray-600">Drag & Drop</button>
    </div>

    <!-- TABLE VIEW -->
    <section id="sectionTable" class="">
        <div class="flex justify-between items-center mb-4">
            <h2 class="text-2xl font-semibold">Categories & Products</h2>
            <div>
                <button id="addCategoryBtn" class="px-4 py-2 bg-green-500 text-white rounded mr-2">+ Kategori</button>
                <button id="addProductBtn" class="px-4 py-2 bg-indigo-500 text-white rounded">+ √úr√ºn</button>
            </div>
        </div>
        <div class="grid grid-cols-2 gap-6">
            <!-- Categories table -->
            <div class="bg-white p-4 shadow rounded">
                <h3 class="font-semibold mb-2">Kategoriler</h3>
                <table class="min-w-full table-auto">
                    <thead>
                    <tr class="bg-gray-50">
                        <th class="px-3 py-1 text-left">#</th>
                        <th class="px-3 py-1 text-left">Ad</th>
                        <th class="px-3 py-1 text-center">ƒ∞≈ülemler</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="cat,stat: ${categories}">
                        <td class="px-3 py-1" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-1" th:text="${cat.name}">Kategori Adƒ±</td>
                        <td class="px-3 py-1 text-center space-x-2">
                            <button class="text-indigo-600 editCatBtn"
                                    th:attr="data-id=${cat.id},data-name=${cat.name}">D√ºzenle
                            </button>
                            <form th:action="@{/admin/categories/delete/{id}(id=${cat.id})}" method="post"
                                  class="inline">
                                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                                <button class="text-red-600" onclick="return confirm('Silinsin mi?')">Sil</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
            <!-- Products table -->
            <div class="bg-white p-4 shadow rounded">
                <h3 class="font-semibold mb-2">√úr√ºnler</h3>
                <table class="min-w-full table-auto">
                    <thead>
                    <tr class="bg-gray-50">
                        <th class="px-3 py-1 text-left">#</th>
                        <th class="px-3 py-1 text-left">Ad</th>
                        <th class="px-3 py-1 text-right">Fiyat</th>
                        <th class="px-3 py-1 text-center">ƒ∞≈ülemler</th>
                    </tr>
                    </thead>
                    <tbody>
                    <tr th:each="p,stat: ${allProducts}">
                        <td class="px-3 py-1" th:text="${stat.index + 1}">1</td>
                        <td class="px-3 py-1" th:text="${p.name}">√úr√ºn Adƒ±</td>
                        <td class="px-3 py-1 text-right" th:text="${#numbers.formatDecimal(p.price,1,2)} + '‚Ç∫'">0 ‚Ç∫</td>
                        <td class="px-3 py-1 text-center space-x-2">
                            <button class="text-indigo-600 editProdBtn"
                                    th:attr="data-id=${p.id},
                                   data-name=${p.name},
                                   data-price=${p.price},
                                   data-cat=${p.category.id}">
                                D√ºzenle
                            </button>
                            <form th:action="@{/admin/products/delete/{id}(id=${p.id})}" method="get" class="inline">
                                <button class="text-red-600" onclick="return confirm('Silinsin mi?')">Sil</button>
                            </form>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </section>

    <!-- DRAG & DROP VIEW -->
    <section id="sectionDrag" class="hidden p-6">

        <div class="flex justify-between mb-4">
            <h2 class="text-2xl font-semibold">Drag & Drop</h2>
            <div>
                <button id="addCategoryBtn2" class="px-4 py-2 bg-green-500 text-white rounded mr-2">+ Kategori</button>
                <button id="addProductBtn2" class="px-4 py-2 bg-indigo-500 text-white rounded">+ √úr√ºn</button>
            </div>
        </div>

        <!-- flex ile 2 par√ßa: sol=2 s√ºtun grid, saƒü=sabit kutu -->
        <div class="flex gap-4">
            <!-- sol taraf: Kategori ƒ±zgarasƒ± -->
            <div class="flex-1 grid grid-cols-2 gap-4">
                <div th:each="cat : ${categories}"
                     class="bg-white p-4 shadow rounded flex flex-col">
                    <h3 class="font-medium mb-2" th:text="${cat.name}">Kategori Adƒ±</h3>
                    <div class="category-drop w-full flex-1 overflow-auto border-2 border-dashed border-gray-300 rounded p-2"
                         th:attr="data-cat-id=${cat.id}">
                        <div th:each="p : ${productsByCategory[cat.id]}"
                             class="product-item p-2 mb-2 bg-indigo-100 rounded cursor-move"
                             th:attr="data-prod-id=${p.id}"
                             th:text="${p.name}">
                            √úr√ºn Adƒ±
                        </div>
                    </div>
                </div>
            </div>

            <!-- saƒü taraf: T√ºm √úr√ºnler -->
            <div class="w-80 flex-shrink-0 bg-white p-4 shadow rounded flex flex-col">
                <h3 class="font-medium mb-2">T√ºm √úr√ºnler</h3>
                <div id="allProducts"
                     class="flex-1 overflow-auto border-2 border-gray-300 rounded p-2">
                    <div th:each="p : ${allProducts}"
                         class="product-item p-2 mb-2 bg-indigo-50 rounded cursor-move"
                         th:attr="data-prod-id=${p.id}"
                         th:text="${p.name}">
                        √úr√ºn Adƒ±
                    </div>
                </div>
            </div>
        </div>

        <!-- CSRF token -->
        <input type="hidden" name="_csrf" th:value="${_csrf.token}"/>
    </section>

</main>

<!-- Offcanvas Drawer (Kategori/√úr√ºn ekle/d√ºzenle) -->
<div id="drawer"
     class="fixed inset-y-0 right-0 w-full md:w-1/3 bg-white shadow-xl transform translate-x-full transition-transform">
    <div class="p-4 border-b flex justify-between items-center">
        <h4 id="drawerTitle" class="text-lg font-semibold">Ba≈ülƒ±k</h4>
        <button id="closeDrawer" class="text-2xl">&times;</button>
    </div>
    <div class="p-6 space-y-4">
        <!-- Category Form -->
        <form th:object="${category}"
              th:action="@{/admin/categories}"
              method="post"
              class="space-y-4 hidden"
              id="categoryForm">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{id}" name="id" id="catId"/>
            <div>
                <label class="block mb-1">Kategori Adƒ±</label>
                <label>
                    <input type="text"
                           th:field="*{name}"
                           id="catName"
                           class="w-full px-3 py-2 border rounded"
                           required/>
                </label>
            </div>
            <div class="flex items-center">
                <input type="checkbox"
                       th:field="*{active}"
                       id="catActive"
                       class="mr-2"/>
                <label for="catActive" class="cursor-pointer">Aktif</label>
            </div>
            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelCat" class="px-4 py-2 bg-gray-200 rounded">ƒ∞ptal</button>
                <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded">Kaydet</button>
            </div>
        </form>
        <!-- Product Form -->
        <form id="productForm"
              th:action="@{/admin/products}"
              method="post"
              enctype="multipart/form-data"
              th:object="${product}"
              class="space-y-4 hidden">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
            <input type="hidden" th:field="*{id}" name="id" id="prodId"/>
            <!-- √úR√úN ADI -->
            <div>
                <label class="block mb-1">√úr√ºn Adƒ±</label>
                <input type="text"
                       th:field="*{name}"
                       class="w-full px-3 py-2 border rounded"
                       required/>
            </div>

            <!-- A√áIKLAMA -->
            <div>
                <label class="block mb-1">A√ßƒ±klama</label>
                <textarea th:field="*{description}"
                          rows="3"
                          class="w-full px-3 py-2 border rounded"
                          required></textarea>
            </div>

            <!-- Fƒ∞YAT -->
            <div>
                <label class="block mb-1">Fiyat</label>
                <input type="number"
                       step="0.01"
                       th:field="*{price}"
                       class="w-full px-3 py-2 border rounded"
                       required/>
            </div>

            <!-- KATEGORƒ∞ -->
            <div>
                <label class="block mb-1">Kategori</label>
                <select th:field="*{category.id}"
                        class="w-full px-3 py-2 border rounded">
                    <option th:each="c : ${categories}"
                            th:value="${c.id}"
                            th:text="${c.name}">Kategori</option>
                </select>
            </div>

            <!-- AKTƒ∞F Mƒ∞? -->
            <div class="flex items-center">
                <input type="checkbox"
                       th:field="*{active}"
                       id="prodActive"
                       class="mr-2"/>
                <label for="prodActive" class="cursor-pointer">Aktif</label>
            </div>

            <!-- PARENT_ID (opsiyonel) -->
            <input type="hidden" th:field="*{parentId}"/>

            <!-- RESƒ∞M Y√úKLE -->
            <div>
                <label class="block mb-1">Resim</label>
                <input type="file"
                       name="imageFile"
                       class="w-full"/>
            </div>

            <div class="flex justify-end space-x-2">
                <button type="button" id="cancelProd" class="px-4 py-2 bg-gray-200 rounded">ƒ∞ptal</button>
                <button type="submit" class="px-4 py-2 bg-indigo-500 text-white rounded">Kaydet</button>
            </div>
        </form>
    </div>
</div>

<script>
    // TAB deƒüi≈üimi
    document.getElementById('tabTable').addEventListener('click', () => {
        document.getElementById('sectionTable').classList.remove('hidden');
        document.getElementById('sectionDrag').classList.add('hidden');
        document.querySelectorAll('#tabTable,#tabDrag').forEach(b => b.classList.toggle('border-b-2'));
    });
    document.getElementById('tabDrag').addEventListener('click', () => {
        document.getElementById('sectionTable').classList.add('hidden');
        document.getElementById('sectionDrag').classList.remove('hidden');
        document.querySelectorAll('#tabTable,#tabDrag').forEach(b => b.classList.toggle('border-b-2'));
    });

    // Offcanvas drawer kontrol√º
    const drawer = document.getElementById('drawer');

    function openForm(type, data = {}) {
        drawer.classList.remove('translate-x-full');
        document.getElementById('categoryForm').classList.toggle('hidden', type !== 'cat');
        document.getElementById('productForm').classList.toggle('hidden', type !== 'prod');
        if (type === 'cat') {
            document.getElementById('drawerTitle').textContent = data.id ? 'Kategori D√ºzenle' : 'Yeni Kategori';
            document.getElementById('catId').value = data.id || '';
            document.getElementById('catName').value = data.name || '';
        } else {
            document.getElementById('drawerTitle').textContent = data.id ? '√úr√ºn D√ºzenle' : 'Yeni √úr√ºn';
            document.getElementById('prodId').value = data.id || '';
            document.getElementById('prodName').value = data.name || '';
            document.getElementById('prodPrice').value = data.price || '';
            document.getElementById('prodCat').value = data.categoryId || '';
            document.getElementById('prodDescription').value = data.description;
            document.getElementById('prodActive').checked = (data.active === 'true');
        }
    }

    document.getElementById('closeDrawer').onclick = () => drawer.classList.add('translate-x-full');
    document.getElementById('cancelCat').onclick = () => drawer.classList.add('translate-x-full');
    document.getElementById('cancelProd').onclick = () => drawer.classList.add('translate-x-full');

    // Kategori / √úr√ºn ekle/d√ºzenle butonlarƒ±
    ['addCategoryBtn', 'addCategoryBtn2'].forEach(id =>
        document.getElementById(id).addEventListener('click', () => openForm('cat'))
    );
    ['addProductBtn', 'addProductBtn2'].forEach(id =>
        document.getElementById(id).addEventListener('click', () => openForm('prod'))
    );
    document.querySelectorAll('.editCatBtn').forEach(btn =>
        btn.addEventListener('click', () => openForm('cat', {
            id: btn.dataset.id,
            name: btn.dataset.name,
            active: btn.dataset.active
        }))
    );
    document.querySelectorAll('.editProdBtn').forEach(btn =>
        btn.addEventListener('click', () => openForm('prod', {
            id: btn.dataset.id,
            name: btn.dataset.name,
            price: btn.dataset.price,
            categoryId: btn.dataset.cat,
            description: btn.dataset.description,
            active:      btn.dataset.active
        }))
    );

    // DRAG & DROP init
    document.addEventListener('DOMContentLoaded', () => {
        // kategori drop b√∂lgelerini init et
        document.querySelectorAll('.category-drop').forEach(dropEl => {
            new Sortable(dropEl, {
                group: 'shared',
                animation: 150,
                onAdd: evt => {
                    const prodId = evt.item.dataset.prodId;
                    const catId  = evt.to.dataset.catId;
                    fetch(`/admin/products/assign/${prodId}/${catId}`, {
                        method: 'POST',
                        headers: { 'X-CSRF-TOKEN': document.querySelector('input[name="_csrf"]').value }
                    });
                }
            });
        });

        // t√ºm √ºr√ºnler listesi draggable olsun
        new Sortable(document.getElementById('allProducts'), {
            group: 'shared',
            animation: 150
        });
    });
</script>
</body>
</html>
